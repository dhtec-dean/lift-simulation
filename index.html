<!DOCTYPE html>
<html>
  <head>
    <title>Reactive Lift Simulation</title>
    <script src="http://fb.me/react-0.9.0.js"></script>
    <script src="http://fb.me/JSXTransformer-0.9.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <style>
	div.floorSection
	{
		height:120px;
		width:360px;
		background-color:#C0C0C0;
		border-bottom:solid #A0A0A0;
		position:relative;
		display:inline-block;
	}
	div.floor
	{
		
	}
	div.lift
	{
		position:absolute;
		bottom:0px;
		left:135px;
		height:100px;
		width:90px;
		background-color:#A0A0A0;
	}
	div.leftDoor
	{
		position:absolute;
		bottom:0px;
		left:135px;
		height:100px;
		width:45px;
		background-color:#B0B0B0;
	}
	div.rightDoor
	{
		position:absolute;
		bottom:0px;
		left:180px;
		height:100px;
		width:45px;
		background-color:#B0B0B0;
		border-left:solid #A0A0A0;
	}
	div.liftDirectionIndicator
	{
		position:absolute;
		bottom:102px;
		left:180px;
		width:15px;
		height:15px;
		background-color:#00A000;
	}
	div.currentFloorIndicator
	{
		position:absolute;
		bottom:102px;
		left:163px;
		width:15px;
		height:15px;
		background-color:#00A000;
	}
	div.buttonPanel
	{
		position:absolute;
		bottom:50px;
		left:105px;
		height:36px;
		width:20px;
	}
	div.button
	{
		height:18px;
		width:20px;
		background-color:#A00000;
	}
	div.pressed
	{
		height:18px;
		width:20px;
		background-color:#FA0000;
	}
	div.person
	{
		position:absolute; 
		bottom:0px;
		height:80px;
		width:20px;
		background-color:#FFFFCC;
		z-index:1;
	}
	div.personWaiting0
	{
		left:227px;
	}
	div.personWaiting1
	{
		left:249px;
	}
	div.personWaiting2
	{
		left:271px;
	}
	div.personWaiting3
	{
		left:293px;
	}
	div.personWaiting4
	{
		left:315px;
	}
	div.personInLift0
	{
		left:2px;
	}
	div.personInLift1
	{
		left:24px;
	}
    </style>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx">
      /**
       * @jsx React.DOM
       */
	  
	  var buildingConfiguration = {
		  lifts: [
	  	{
			liftAtFloor: 0, 
			doorsOpen: true, 
			peopleInLift: [{goingTo: 1}, {goingTo: 2}],
			direction: "UP"
	  	},
	  	{
			liftAtFloor: 2, 
			doorsOpen: true, 
			peopleInLift: [{goingTo: 0}],
			direction: "DOWN"
	  	}
		  ],
		  floors: [
			{peopleWaiting: []},
			{peopleWaiting: [{goingTo: 0}]},
			{peopleWaiting: [{goingTo: 1}, {goingTo: 2}]}
		  ]
	  };
	  
	  var Person = React.createClass({
		  render: function() {
			  var className = "person person" + this.props.waitingOrInLift + this.props.position;
			  var goingTo = this.props.goingTo;
			  return(
				  <div className={className} >{goingTo}</div> 
			  );
		  }	  	
	  });
	  
	  var Lift =  React.createClass({
		  render: function() {
			  var peopleInLift = this.props.lift.peopleInLift.map(function(person, position){
				return <Person position={position} goingTo={person.goingTo} waitingOrInLift="InLift" />
			  });
			  var liftIsAtThisFloor = (this.props.lift.liftAtFloor == this.props.floorNumber);
			  if(liftIsAtThisFloor && this.props.lift.doorsOpen){
				  return(
					  <div className="lift">
					  	{peopleInLift}
					  </div>
				  );
			  } else {
				  return(
					  <div>
					  	<div className="leftDoor" />
						<div className="rightDoor" />
					  </div>
			  	);
			  }
		  }
	  });
	  
	  var CallButton = React.createClass({
		  render: function() {
			  var upButtonClass = "button"
			  if(this.props.liftUpRequested){
				  upButtonClass += " pressed"
			  }
			  var downButtonClass = "button"
			  if(this.props.liftDownRequested){
				  downButtonClass += " pressed"
			  }
			  return(
				  <div className="buttonPanel">
				  	<div className={upButtonClass} />
				  	<div className={downButtonClass} />
				  </div>
			  );
		  }
	  });
	  
	  var LiftDirectionIndicator = React.createClass({
		  render: function() {
			  var direction = "U";
			  if(this.props.direction == "DOWN"){
				  direction = "D";
			  }
			  return (
				 <div className="liftDirectionIndicator">{direction}</div>
			  );
		  }
	  });
	  
	  var CurrentFloorIndicator = React.createClass({
		  render: function() {
			  var currentFloor = this.props.currentFloor;
			  return (
				 <div className="currentFloorIndicator">{currentFloor}</div>
			  );
		  }
	  });
	  
	  var FloorSection = React.createClass({
	    render: function() {
			var people = this.props.peopleWaiting.map(function(person, position){
				return <Person position={position} goingTo={person.goingTo} waitingOrInLift="Waiting" />
			});
			var floorNumber = this.props.floorNumber;
			var liftAtFloor = this.props.lift.liftAtFloor;
			var liftDirection = this.props.lift.direction;
			var liftUpRequested = this.props.peopleWaiting.reduce(function(someoneIsGoingUp, person){
				if(someoneIsGoingUp) return true;				
				return person.goingTo > floorNumber;
			}, false);
			var liftDownRequested = this.props.peopleWaiting.reduce(function(someoneIsGoingDown, person){
				if(someoneIsGoingDown) return true;				
				return person.goingTo < floorNumber;
			}, false);
	    	return (
 				<div className="floorSection">
					<CallButton liftUpRequested={liftUpRequested} liftDownRequested={liftDownRequested} />
					<LiftDirectionIndicator direction={liftDirection} />
					<CurrentFloorIndicator currentFloor={liftAtFloor} />
					<Lift lift={this.props.lift} floorNumber={floorNumber} />
					{people}
				</div>
			);
	    }	
	  });
	  
	  var Floor = React.createClass({
	    render: function() {
			var floorSections = new Array();
			var noOfSectionsPerFloor = this.props.lifts.length;
			var noOfPeopleWaiting = this.props.peopleWaiting.length;
			var peopleWaitingPerSection = new Array();
			var maxNoOfPeoplePerSection = 3;
			for(sectionNo=0; sectionNo< noOfSectionsPerFloor; sectionNo++){
				var floorNumber = this.props.floorNumber;
				var peopleWaiting = new Array();
				var startTakingPeopleFrom = sectionNo * maxNoOfPeoplePerSection;
				var takePeopleUntil = startTakingPeopleFrom + maxNoOfPeoplePerSection;
				var peopleWaitingPosition = 0;
				var lift = this.props.lifts[sectionNo];
				for(personAt=startTakingPeopleFrom; personAt<takePeopleUntil && personAt<noOfPeopleWaiting; personAt++){
					peopleWaiting[peopleWaitingPosition] = this.props.peopleWaiting[personAt];
					peopleWaitingPosition++;
				}
				floorSections[sectionNo] = <FloorSection peopleWaiting={peopleWaiting} floorNumber={floorNumber} lift={lift}/>
			}
	    	return (
				<div className="floor">
					{floorSections}
				</div>
			);
	    }	
	  });
	  
	  var Scene = React.createClass({
	    render: function() {
			var noOfFloors = this.props.buildingConfiguration.floors.length;
			var lifts = this.props.buildingConfiguration.lifts;
			var floors = this.props.buildingConfiguration.floors.map(function(floor, index){
				return <Floor peopleWaiting={floor.peopleWaiting} floorNumber={noOfFloors - index -1} lifts={lifts}/>
			});
			
	      return (
		      <div className="building">
		        {floors}
		      </div>
	      );
	    }
	  });
	  
	  React.renderComponent(
	    <Scene buildingConfiguration={buildingConfiguration}/>,
	    document.getElementById('content')
	  );
	  
    </script>
</body>
</html>