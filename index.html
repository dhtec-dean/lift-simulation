<!DOCTYPE html>
<html>
  <head>
	<link href="liftSimulator.css" rel="stylesheet" type="text/css" />
    <script src="http://fb.me/react-0.9.0.js"></script>
    <script src="http://fb.me/JSXTransformer-0.9.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <title>Reactive Lift Simulation</title>
  </head>
  <body>
  <!--<body onload="init();">-->
    <div id="content"></div>
    <script type="text/jsx">
      /**
       * @jsx React.DOM
       */
	  
	  var buildingConfiguration = {
		  lifts: [
  	  	{
  			liftAtFloor: 0, 
  			doorsOpen: true, 
  			peopleInLift: [{goingTo: 1}, {goingTo: 2}],
  			direction: "UP"
  	  	},{
    			liftAtFloor: 0, 
    			doorsOpen: true, 
    			peopleInLift: [{goingTo: 1}, {goingTo: 2}],
    			direction: "UP"
    	  	}
		  ],
		  floors: [
			{peopleWaiting: [{goingTo: 0}]},
			{peopleWaiting: []},
			{peopleWaiting: [{goingTo: 1}, {goingTo: 2}]}
		  ]
	  };
	  
	  var Person = React.createClass({
		  render: function() {
			  var className = "person person" + this.props.waitingOrInLift + this.props.position;
			  var goingTo = this.props.goingTo;
			  return(
				  <div className={className} >{goingTo}</div> 
			  );
		  }	  	
	  });
	  
	  var Lift =  React.createClass({
		  render: function() {
			  var peopleInLift = this.props.lift.peopleInLift.map(function(person, position){
				return <Person position={position} goingTo={person.goingTo} waitingOrInLift="InLift" />
			  });
			  var liftIsAtThisFloor = (this.props.lift.liftAtFloor == this.props.floorNumber);
			  if(liftIsAtThisFloor && this.props.lift.doorsOpen){
				  return(
					  <div className="lift">
					  	{peopleInLift}
					  </div>
				  );
			  } else {
				  return(
					  <div>
					  	<div className="leftDoor" />
						<div className="rightDoor" />
					  </div>
			  	);
			  }
		  }
	  });
	  
	  var CallButton = React.createClass({
		  render: function() {
			  var upButtonClass = "button"
			  if(this.props.liftUpRequested){
				  upButtonClass += " pressed"
			  }
			  var downButtonClass = "button"
			  if(this.props.liftDownRequested){
				  downButtonClass += " pressed"
			  }
			  return(
				  <div className="buttonPanel">
			  	<div className={upButtonClass} />
			  	<div className={downButtonClass} /> 
				  </div>
			  );
		  }
	  });
	  
	  var LiftDirectionIndicator = React.createClass({
		  render: function() {
			  var direction = "U";
			  if(this.props.direction == "DOWN"){
				  direction = "D";
			  }
			  return (
				 <div className="liftDirectionIndicator">{direction}</div>
			  );
		  }
	  });
	  
	  var CurrentFloorIndicator = React.createClass({
		  render: function() {
			  var currentFloor = this.props.currentFloor;
			  return (
				 <div className="currentFloorIndicator">{currentFloor}</div>
			  );
		  }
	  });
	  
	  var FloorSection = React.createClass({
	    render: function() {
			var people = this.props.peopleWaiting.map(function(person, position){
				return <Person position={position} goingTo={person.goingTo} waitingOrInLift="Waiting" />
			});
			var floorNumber = this.props.floorNumber;
			var liftAtFloor = this.props.lift.liftAtFloor;
			var liftDirection = this.props.lift.direction;
			var liftUpRequested = this.props.liftUpRequested;
			var liftDownRequested = this.props.liftDownRequested;
	    	return (
 				<div className="floorSection">
					<CallButton liftUpRequested={liftUpRequested} liftDownRequested={liftDownRequested} />
					<LiftDirectionIndicator direction={liftDirection} />
					<CurrentFloorIndicator currentFloor={liftAtFloor} />
					<Lift lift={this.props.lift} floorNumber={floorNumber} />
					{people}
				</div>
			);
	    }	
	  });
	  
	  var Floor = React.createClass({
	    render: function() {
			var floorSections = new Array();
			var noOfSectionsPerFloor = this.props.lifts.length;
			var noOfPeopleWaiting = this.props.peopleWaiting.length;
			var peopleWaitingPerSection = new Array();
			var maxNoOfPeoplePerSection = 3;
			for(sectionNo=0; sectionNo< noOfSectionsPerFloor; sectionNo++){
				var floorNumber = this.props.floorNumber;
				var liftUpRequested = this.props.peopleWaiting.reduce(function(someoneIsGoingUp, person){
					if(someoneIsGoingUp) return true;				
					return person.goingTo > floorNumber;
				}, false);
				var liftDownRequested = this.props.peopleWaiting.reduce(function(someoneIsGoingDown, person){
					if(someoneIsGoingDown) return true;				
					return person.goingTo < floorNumber;
				}, false);
				var peopleWaiting = new Array();
				var startTakingPeopleFrom = sectionNo * maxNoOfPeoplePerSection;
				var takePeopleUntil = startTakingPeopleFrom + maxNoOfPeoplePerSection;
				var peopleWaitingPosition = 0;
				var lift = this.props.lifts[sectionNo];
				for(personAt=startTakingPeopleFrom; personAt<takePeopleUntil && personAt<noOfPeopleWaiting; personAt++){
					peopleWaiting[peopleWaitingPosition] = this.props.peopleWaiting[personAt];
					peopleWaitingPosition++;
				}
				floorSections[sectionNo] = <FloorSection peopleWaiting={peopleWaiting} floorNumber={floorNumber} lift={lift} liftUpRequested={liftUpRequested} liftDownRequested={liftDownRequested} />
			}
	    	return (
				<div className="floor">
					{floorSections}
				</div>
			);
	    }	
	  });
	  
	  var Scene = React.createClass({
		  getInitialState: function() {
			  return {
		  		lifts: [],
		  	  	floors: []
	  	  	  };
		  },
		  componentWillMount: function() {
        var Socket = "MozWebSocket" in window ? MozWebSocket : WebSocket;
        var ws = new Socket("ws://localhost:8080/foo/bar?hello=world");

		console.log(this);
		var react = this;
        ws.onmessage = function(evt) { 
			console.log("Received: " + evt.data); 

/*
			
			WORKS: 
						
			console.log("this: " + this.toString());
			react.setState(JSON.parse('{"lifts": [{"liftAtFloor": 0, "doorsOpen": true, "peopleInLift": [{"goingTo": 1}, {"goingTo": 2}],"direction": "UP"},{"liftAtFloor": 0, "doorsOpen": true, "peopleInLift": [{"goingTo": 1}, {"goingTo": 2}],"direction": "UP"}],"floors": [{"peopleWaiting": [{"goingTo": 0}]},{"peopleWaiting": []},{"peopleWaiting": [{"goingTo": 1}, {"goingTo": 2}]}]}'));
				  
*/
			
			
			react.setState(JSON.parse(  evt.data));
		};
        ws.onclose = function(event) {        };
        ws.onopen = function() {
          ws.send("getBuilding");
        };
		
		          return {
		              filterText: '',
		              inStockOnly: false
		          };
		      },
		  
	    render: function() {
			var noOfFloors = this.state.floors.length;
			var lifts = this.state.lifts;
			var floors = this.state.floors.map(function(floor, index){
				return <Floor peopleWaiting={floor.peopleWaiting} floorNumber={noOfFloors - index -1} lifts={lifts}/>
			});
			
	      return (
		      <div className="building">
		        {floors}
		      </div>
	      );
	    }
	  });
	  
	  React.renderComponent(
	    <Scene buildingConfiguration={buildingConfiguration}/>,
	    document.getElementById('content')
	  );
	  
    </script>
</body>
</html>
